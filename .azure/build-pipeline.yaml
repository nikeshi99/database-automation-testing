resources:
  containers:
  - container: LBPRO
    image: liquibase/liquibase:latest
    options: --user 0:0
trigger: 
- main
pr: none
variables:
- group: Liquibase DEV
pool:
  vmImage: ubuntu-latest
container: LBPRO
jobs:
- job: DockerBuild

  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - task: Docker@2
    inputs:
      containerRegistry: 'Docker Hub'
      repository: 'nikeshi/databaseAutomationTesting'
      command: 'buildAndPush'
      Dockerfile: 'database-automation-testing/app/src/data-backed-service/DOCKERFILE'
      buildContext: 'database-automation-testing/'
      tags: |
        latest
  - script: |
      docker run -d -p 8080:8080 nikeshi/databaseAutomationTesting:v1
      sleep 80
      curl http://localhost:8080/employees
steps:
- script: |
    liquibase --version
    liquibase checks run
    liquibase tag $(Build.BuildId)
    liquibase update
    liquibase history
  displayName: 'Running Liquibase commands'

- script: |
    mkdir $(System.DefaultWorkingDirectory)/artifacts
    tar -czf $(System.DefaultWorkingDirectory)/artifacts/$(appname)-$(Build.BuildId).tar.gz .
  displayName: 'Creating Artifact'


- upload: $(System.DefaultWorkingDirectory)/artifacts/$(appname)-$(Build.BuildId).tar.gz
  artifact: MyApp